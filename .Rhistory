'D3' = '#E60000',
'D4' = '#730000')) +
plot_theme()
raster::raster('./data/in_features/tif/constant/pr-const.tif')
raster::raster('./data/in_features/tif/constant/pr-const.tif') %>% raster::plot()
raster::raster('./data/in_features/tif/constant/pr-const.tif') -> a
a[!is.na(a)] = 1
a[is.na(a)] = 0
raster::plot(a)
raster::writeRaster(a, './data/in_features/pix_mask.tif')
f = './data/models/lstm/seq/metadata_0_seq.p'
library(reticulate)
library(magrittr)
library(ggplot2)
use_condaenv("gee", conda = "/opt/miniconda3/bin/conda")
source_python('~/projects/DroughtCast/crdm/utils/ReadPickle.py')
source('https://raw.githubusercontent.com/colinbrust/DroughtCast/revert/crdm/R/PlotTheme.R')
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)),
sample_name = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2))
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)),
sample_name = basename(f) %>%
stringr::str_split('_') %>%
magrittr::extract(2))
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)),
sample_name = basename(f) %>%
stringr::str_split('_') )
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', '))
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble()
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f)),
sample_name = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2))
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f)),
sample_name = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2)) %$% sample_name
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2))
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2))
library(reticulate)
library(magrittr)
library(ggplot2)
use_condaenv("gee", conda = "/opt/miniconda3/bin/conda")
source_python('~/projects/DroughtCast/crdm/utils/ReadPickle.py')
source('https://raw.githubusercontent.com/colinbrust/DroughtCast/revert/crdm/R/PlotTheme.R')
read_metadata <- function(f) {
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2))
}
read_error <- function(f) {
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2)) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
}
pth = './data/models/lstm'
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err.p') %>%
lapply(read_error) %>%
dplyr::bind_rows()
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
err
metadata
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err_') %>%
lapply(read_error) %>%
dplyr::bind_rows()
err
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
metadata
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2)) %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop))
f
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble()
list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop))
list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop)) %>%
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes))
metadata
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
metadata
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq, clip)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
metadata
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err_') %>%
lapply(read_error) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = as.numeric(model_id))
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq, clip)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
pth
read_all <- function(pth) {
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err_') %>%
lapply(read_error) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = as.numeric(model_id))
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq, clip)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
}
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(model_id == 0) %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_class)) +
geom_line()
read_all(pth)
read_all(pth) %>% dplyr::filter(model_class == 'vanilla')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(model_id == 0) %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_class)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_class)) +
geom_line() +
facet_wrap(~model_id)
raster::raster('./data/models/lstm/seq/preds/20070102_preds.tif')
raster::raster('./data/models/lstm/seq/preds/20070102_preds.tif') %>% raster::plot()
raster::stack('./data/models/lstm/seq/preds/20070102_preds.tif') %>% raster::plot()
raster::stack('./data/models/lstm/seq/preds/20070116_preds.tif') %>% raster::plot()
raster::stack('./data/models/lstm/seq/preds/20070116_targets.tif') %>% raster::plot()
raster::stack('./data/models/lstm/preds/20030708_preds.tif') %>% raster::plot()
raster::stack('./data/models/lstm/preds/20030701_preds.tif') %>% raster::plot()
raster::stack('./data/models/lstm/vanilla/preds/20070102_preds.tif') %>% raster::plot()
raster::stack('./data/models/lstm/seq/preds/20070102_preds.tif') %>% raster::plot()
f = './data/models/lstm/seq/preds/20070102_preds.tif'
f
f %>%
raster::stack() %>%
raster::rasterToPoints()
f %>%
raster::stack() %>%
raster::rasterToPoints() %>%
tibble::as_tibble()
f %>%
raster::stack() %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c(x, y, paste('lt', 1:12, sep='_')))
f %>%
raster::stack() %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c('x', 'y', paste('lt', 1:12, sep='_')))
f %>%
raster::stack() %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c('x', 'y', paste('lt', 1:12, sep='_'))) %>%
tidyr::pivot_longer(
dplyr::starts_with('lt'),
names_to = 'lead_time',
values_to = 'val'
)
f %>%
raster::stack() %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c('x', 'y', paste('lt', 1:12, sep='_'))) %>%
tidyr::pivot_longer(
dplyr::starts_with('lt'),
names_to = 'lead_time',
values_to = 'val'
) -> a
a
a %>%
ggplot(aes(x=x, y=y, fill=val)) +
geom_raster() +
facet_wrap(~lead_time)
states <- urbnmapr::get_urbn_map(sf = TRUE) %>%
dplyr::filter(state_abbv != 'AK', state_abbv != 'HI') %>%
sf::st_transform(6933)
ggplot() +
geom_raster(data = a, mapping = aes(x=x, y=y, fill=val)) +
geom_sf(data = states, mapping = aes())
f %>%
raster::stack() %>%
raster::crop(states) %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c('x', 'y', paste('lt', 1:12, sep='_'))) %>%
tidyr::pivot_longer(
dplyr::starts_with('lt'),
names_to = 'lead_time',
values_to = 'val'
) -> a
a
f %>%
raster::stack() %>%
raster::crop(states) %>% raster::plot()
f %>%
raster::stack() %>%
raster::mask(states) %>% raster::plot()
f %>%
raster::stack() %>%
raster::mask(states) %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c('x', 'y', paste('lt', 1:12, sep='_'))) %>%
tidyr::pivot_longer(
dplyr::starts_with('lt'),
names_to = 'lead_time',
values_to = 'val'
) -> a
a
ggplot() +
geom_raster(data = a, mapping = aes(x=x, y=y, fill=val)) +
geom_sf(data = states, mapping = aes(), fill=NA)
ggplot() +
geom_raster(data = a, mapping = aes(x=x, y=y, fill=val)) +
geom_sf(data = states, mapping = aes(), fill=NA) +
facet_wrap(~lead_time) +
plot_theme()
ggplot() +
geom_raster(data = a, mapping = aes(x=x, y=y, fill=val)) +
geom_sf(data = states, mapping = aes(), fill=NA) +
facet_wrap(~lead_time) +
plot_theme()
f %>%
raster::stack() %>%
raster::mask(states) %>%
raster::rasterToPoints() %>%
tibble::as_tibble() %>%
`names<-`(c('x', 'y', paste('lt', 1:12, sep='_'))) %>%
tidyr::pivot_longer(
dplyr::starts_with('lt'),
names_to = 'lead_time',
values_to = 'val'
) %>%
dplyr::mutate(val = round(val),
val = dplyr::recode(
val,
`0` = 'No Drought',
`1` = 'D0',
`2` = 'D1',
`3` = 'D2',
`4` = 'D3',
`5` = 'D4'))-> a
ggplot() +
geom_raster(data = a, mapping = aes(x=x, y=y, fill=val)) +
geom_sf(data = states, mapping = aes(), fill=NA, size = 0.5) +
facet_wrap(~lead_time) +
plot_theme() +
scale_fill_manual(values = c('No Drought' = NA,
'D0' = '#FFFF00',
'D1' = '#FCD37F',
'D2' = '#FFAA00',
'D3' = '#E60000',
'D4' = '#730000'))
library(reticulate)
library(magrittr)
library(ggplot2)
use_condaenv("gee", conda = "/opt/miniconda3/bin/conda")
source_python('~/projects/DroughtCast/crdm/utils/ReadPickle.py')
source('https://raw.githubusercontent.com/colinbrust/DroughtCast/revert/crdm/R/PlotTheme.R')
read_metadata <- function(f) {
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2))
}
read_error <- function(f) {
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_class = basename(dirname(f)),
model_id = basename(f) %>%
stringr::str_split('_') %>%
unlist() %>%
magrittr::extract(2)) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
}
read_all <- function(pth) {
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err_') %>%
lapply(read_error) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = as.numeric(model_id))
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq, clip)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
}
plot_all <- function(pth, ...) {
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_class)) +
geom_line() +
facet_wrap(~model_id)
}
pth = './data/models/lstm'
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err_') %>%
lapply(read_error) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = as.numeric(model_id))
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq, clip)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
err
metadata
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
read_all <- function(pth) {
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err_') %>%
lapply(read_error) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = as.numeric(model_id))
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata_'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()  %>%
dplyr::select(-c(dirname, criterion, pix_mask, model_type, early_stop,
in_features, out_classes, seq, clip)) %>%
dplyr::mutate(dplyr::across(!dplyr::ends_with('class'), as.numeric))
dplyr::left_join(err, metadata, by=c('model_id', 'model_class'))
}
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(dplyr::starts_with('seq'))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test',
model_class %in% c('seq32', 'seq64', 'seq128')) %>%
ggplot(aes(x=epoch, y=err, color=model_class)) +
geom_line() +
facet_wrap(~model_id)
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test',
model_class %in% c('seq32', 'seq64', 'seq128')) %>%
ggplot(aes(x=epoch, y=err, color=model_class)) +
geom_line() +
facet_wrap(~model_id) +
ylim(c(0, 0.01))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id)) %>%
dplyr::filter(set == 'test',
model_class %in% c('seq32', 'seq64', 'seq128')) %>%
ggplot(aes(x=epoch, y=err, color=hidden_size)) +
geom_line() +
facet_wrap(~batch_size) +
ylim(c(0, 0.01))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id),
batch_size = factor(batch_size),
hidden_size = factor(hidden_size)) %>%
dplyr::filter(set == 'test',
model_class %in% c('seq32', 'seq64', 'seq128')) %>%
ggplot(aes(x=epoch, y=err, color=hidden_size)) +
geom_line() +
facet_wrap(~batch_size) +
ylim(c(0, 0.01))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = factor(model_id),
batch_size = factor(batch_size),
hidden_size = factor(hidden_size)) %>%
dplyr::filter(set == 'train',
model_class %in% c('seq32', 'seq64', 'seq128')) %>%
ggplot(aes(x=epoch, y=err, color=hidden_size)) +
geom_line() +
facet_wrap(~batch_size) +
ylim(c(0, 0.01))
