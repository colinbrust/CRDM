err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err.p') %>%
lapply(read_error) %>%
dplyr::bind_rows()
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
metadata
f
f = './data/model_results/unbranched/model0/metadata'
f = './data/model_results/unbranched/model0/metadata.p'
f = './data/model_results/unbranched/model1/metadata.p'
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f)))
read_pickle(f)
read_pickle(f) %>% names
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(names_from = 'feats')
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(names_from = feats)
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(names_from = feats,
values_from = c(NA, NA))
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(names_from = feats,
values_from = c(1, 1))
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(names_from = feats,
values_from =  n_weeks)
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(names_from = 'feats',
values_from =  'n_weeks')
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f)))
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(feats, names_from = feats, values_from = n_weeks)
read_pickle(f) %>%
tibble::as_tibble() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tidyr::pivot_wider(tidyr::everything(), names_from = feats, values_from = n_weeks)
read_pickle(f)
read_pickle(f) %>%
lapply(tibble::as_tibble)
read_pickle(f)
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', '))
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
lapply(tibble::as_tibble)
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble()
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric))
read_metadata <- function(f) {
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)))
}
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)))
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err.p') %>%
lapply(read_error) %>%
dplyr::bind_rows()
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
err
metadata
err
dplyr::left_join(err, metadata, by='model_id')
read_all <- function(pth) {
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err.p') %>%
lapply(read_error) %>%
dplyr::bind_rows()
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
dplyr::left_join(err, metadata, by='model_id')
}
pth
read_all(pth)
test <- function(...) {}
test <- function(...) {print(...)}
test('a', 'b')
test <- function(...) {print(list(...))}
test('a', 'b')
read_all(pth)
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'test')
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tibble::rowid_to_column()
f
f = "./data/model_results/unbranched/model1/err.p"
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tibble::rowid_to_column()
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
read_error <- function(f) {
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
}
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'test')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'test') %>%
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'test')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::filter(set == 'train') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric)
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
factor()) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
metadata
library(reticulate)
library(magrittr)
library(ggplot2)
use_condaenv("gee", conda = "/opt/miniconda3/bin/conda")
source_python('~/projects/DroughtCast/crdm/utils/ReadPickle.py')
source('https://raw.githubusercontent.com/colinbrust/DroughtCast/revert/crdm/R/PlotTheme.R')
read_metadata <- function(f) {
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)))
}
read_error <- function(f) {
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
}
read_all <- function(pth) {
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err.p') %>%
lapply(read_error) %>%
dplyr::bind_rows()
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
dplyr::left_join(err, metadata, by='model_id')
}
plot_all <- function(pth, ...) {
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
}
read_file <- function() {
read_pickle(f) %>%
lapply(function(x) lapply(x,mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
tibble::rowid_to_column() %>%
dplyr::mutate(f = basename(f)) %>%
}
plot_all <- function(f_dir='~/projects/DroughtCast/data/model_results/unet/crop16/') {
f_dir %>%
list.files(full.names = T, pattern = 'err.p') %>%
lapply(read_file) %>%
dplyr::bind_rows() %>%
dplyr::arrange(rerun, rowid) %>%
dplyr::select(-rowid) %>%
tibble::rowid_to_column() %>%
tidyr::pivot_longer(c(train, test), names_to='set') %>%
dplyr::mutate(batch = factor(batch),
hiddenSize = factor(hiddenSize),
nWeeks = factor(nWeeks)) %>%
ggplot(aes(x=rowid, y=value, color=set)) +
geom_line() +
labs(x='Epoch', y='MSE Loss', color='Train/Test Set') +
plot_theme()
}
pth = '~/projects/DroughtCast/data/model_results/tcn'
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
dplyr::filter(set == 'test') %>%
dplyr::slice(which.min(err))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>%
dplyr::slice(which.min(err))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'train') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>%
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>% dplyr::group_by(model_id) %>% dplyr::mutate(err = mean(err)) %>% dplyr::distinct()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err)) %>% View()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err)) %>% View()
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err))
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'test') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err)) -> a
View(a)
a
View(a)
a
tail(a)
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'train') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err)) -> a
a
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
metadata
dplyr::full_join(metadata, a, 'model_id')
err
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'train') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err), model_id = unique(model_id)) -> a
dplyr::full_join(metadata, a, 'model_id')
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'train') %>% dplyr::group_by(model_id) %>% dplyr::summarise(err = mean(err), model_id = paste0('model', unique(model_id))) -> a
dplyr::full_join(metadata, a, 'model_id')
dplyr::full_join(metadata, a, 'model_id') %>% View()
dplyr::full_join(metadata, a, 'model_id') %>% as.data.frame()
dplyr::full_join(metadata, a, 'model_id') %>% dplyr::arrange(err) %>% as.data.frame()
readr::read_csv('/Users/colinbrust/projects/DroughtCast/data/in_features/memmap/smart/mei.csv')
raster::raster('./scratch/20070102_preds.tif') %>% raster::plot()
library(magrittr)
raster::raster('./scratch/20070102_preds.tif') %>% raster::plot()
raster::stack('./scratch/20070102_preds.tif') %>% raster::plot()
raster::stack('./scratch/20070102_targets.tif') %>% raster::plot()
raster::stack('./scratch/20070102_preds.tif') %>% raster::plot()
raster::stack('./scratch/20070522_preds.tif') %>% raster::plot()
raster::stack('./scratch/20070522_targets.tif') %>% raster::plot()
raster::stack('./scratch/20070102_preds.tif_preds.tif') %>% raster::plot()
raster::stack('./scratch/20070102_preds.tif') %>% raster::plot()
fs <- list.files('~/projects/DroughtCast/data/models/lstm', full.names = T, pattern = 'err')
fs
library(reticulate)
library(magrittr)
library(ggplot2)
use_condaenv("gee", conda = "/opt/miniconda3/bin/conda")
source_python('~/projects/DroughtCast/crdm/utils/ReadPickle.py')
source('https://raw.githubusercontent.com/colinbrust/DroughtCast/revert/crdm/R/PlotTheme.R')
read_metadata <- function(f) {
read_pickle(f) %>%
lapply(function(x) paste(x, collapse=', ')) %>%
tibble::as_tibble() %>%
dplyr::mutate(across(!dplyr::starts_with('feats'), as.numeric)) %>%
dplyr::mutate(model_id = basename(dirname(f)))
}
read_error <- function(f) {
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id = basename(dirname(f))) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
}
read_all <- function(pth) {
err <-  list.files(pth, recursive = T, full.names = T, pattern = 'err.p') %>%
lapply(read_error) %>%
dplyr::bind_rows()
metadata <- list.files(
pth, recursive = T, full.names = T, pattern = 'metadata.p'
) %>%
lapply(read_metadata) %>%
dplyr::bind_rows()
dplyr::left_join(err, metadata, by='model_id')
}
plot_all <- function(pth, ...) {
read_all(pth) %>%
tidyr::pivot_longer(c(train, test), names_to = 'set', values_to = 'err') %>%
dplyr::mutate(model_id = stringr::str_replace(model_id, 'model', '') %>%
as.numeric() %>%
factor()) %>%
dplyr::filter(set == 'train') %>%
ggplot(aes(x=epoch, y=err, color=model_id)) +
geom_line()
}
read_file <- function() {
read_pickle(f) %>%
lapply(function(x) lapply(x,mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
tibble::rowid_to_column() %>%
dplyr::mutate(f = basename(f)) %>%
}
plot_all <- function(f_dir='~/projects/DroughtCast/data/model_results/unet/crop16/') {
f_dir %>%
list.files(full.names = T, pattern = 'err.p') %>%
lapply(read_file) %>%
dplyr::bind_rows() %>%
dplyr::arrange(rerun, rowid) %>%
dplyr::select(-rowid) %>%
tibble::rowid_to_column() %>%
tidyr::pivot_longer(c(train, test), names_to='set') %>%
dplyr::mutate(batch = factor(batch),
hiddenSize = factor(hiddenSize),
nWeeks = factor(nWeeks)) %>%
ggplot(aes(x=rowid, y=value, color=set)) +
geom_line() +
labs(x='Epoch', y='MSE Loss', color='Train/Test Set') +
plot_theme()
}
f = fs[1]
f
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows()
d
f
f %>% basename() %>% stringr::str_split('_')
f %>% basename() %>% stringr::str_split('_') %>% unlist() %>% magrittr::extract(2)
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id =f %>% basename() %>%
stringr::str_split('_') %>%
unlist() %>% magrittr::extract(2)
)
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id =f %>% basename() %>%
stringr::str_split('_') %>%
unlist() %>% magrittr::extract(2)) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
read_error <- function(f) {
read_pickle(f) %>%
lapply(function(x) lapply(x, mean)) %>%
lapply(tibble::as_tibble) %>%
dplyr::bind_rows() %>%
dplyr::mutate(model_id =f %>% basename() %>%
stringr::str_split('_') %>%
unlist() %>% magrittr::extract(2)) %>%
tibble::rowid_to_column() %>%
dplyr::rename(epoch=rowid)
}
fs %>% lapply(read_error)
0.00319 ** 0.5
0.00247 ** 0.5
raster::stack('./scratch/20070102_preds.tif')  %>% raster::plot()
library(magrittr)
raster::stack('./scratch/20070102_preds.tif')  %>% raster::plot()
raster::stack('./scratch/20070102_targets.tif')  %>% raster::plot()
raster::stack('./scratch/20070522_preds.tif')  %>% raster::plot()
raster::stack('./scratch/20070522_targets.tif')  %>% raster::plot()
library(magrittr)
raster::stack('./scratch/20070102_preds.tif')  %>% raster::plot()
raster::stack('./scratch/20070102_targets.tif')  %>% raster::plot()
